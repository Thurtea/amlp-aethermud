#!/bin/bash

if [ $1 ]
then
export DRIVER=$1
else
export DRIVER="driver"
fi

if [ $2 ]
then
export CFG="mudos."$2".cfg"
else
export CFG="mudos.cfg"
fi

echo "driver: "$DRIVER
echo "cfg: "$CFG

# Determine the MUD home directory (script parent by default).
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
if [ -z "$MUDHOME" ]; then
    MUDHOME="$SCRIPT_DIR/.."
fi
MUDHOME="$(cd "$MUDHOME" && pwd)"

# It has been reported that non-US users have problems
# with some .o files because their systems default to
# commas for decimal notation and not periods. The
# following language exports are for the benefit of
# people who run into this problem.

LANG=en_US
LANGUAGE=en_US
LC_ALL=en_US

# Uncomment the following if you're on Solaris 10 with a
# 32 bit compiler and need to get around the 256 FD limit.
# NOTE: It will break things. The correct fix is to  compile 
# with a 64 bit compiler and set ENABLE_M64 in build.FluffOS to 1
#LD_PRELOAD_32=/usr/lib/extendedFILE.so.1
#export LD_PRELOAD_32

export LANG LANGUAGE LC_ALL MUDHOME

umask 007

ulimit -a 
ulimit -n 2048
ulimit -a 

while [ true ]; do

    cat $MUDHOME/lib/log/runtime >> $MUDHOME/lib/log/runtime.boot
    rm $MUDHOME/lib/log/runtime

    if [ -n "$MUDHOME" ] && [ -f "$MUDHOME/bin/$DRIVER" ]  && [ -f "$MUDHOME/bin/$CFG" ]
        then
        # Read configured external port from the cfg (if present) for user feedback
        CFG_PATH="$MUDHOME/bin/$CFG"
        if [ -f "$CFG_PATH" ]; then
            EXTPORT=$(awk -F: '/^external_port_1/ {print $2; exit}' "$CFG_PATH" | tr -d ' ' | grep -o '[0-9]\+' || true)
            if [ -n "$EXTPORT" ]; then
                echo "Configured external port: $EXTPORT"
            fi
        fi

        # Try several possible driver locations to match project layout:
        # 1) $MUDHOME/bin/$DRIVER (standard)
        # 2) $MUDHOME/../../build/driver (this repo: mud-references/.../bin -> project root/build/driver)
        # 3) $MUDHOME/../build/driver (one level up, just in case)
        # 4) fallback to ./driver with cfg in current dir
        if [ -f "$MUDHOME/bin/$DRIVER" ] && [ -f "$CFG_PATH" ]; then
            exec "$MUDHOME/bin/$DRIVER" "$CFG_PATH"
        elif [ -f "$MUDHOME/../../build/driver" ] && [ -f "$CFG_PATH" ]; then
            echo "Using driver at: $MUDHOME/../../build/driver"
            exec "$MUDHOME/../../build/driver" "$CFG_PATH"
        elif [ -f "$MUDHOME/../build/driver" ] && [ -f "$CFG_PATH" ]; then
            echo "Using driver at: $MUDHOME/../build/driver"
            exec "$MUDHOME/../build/driver" "$CFG_PATH"
        elif [ -f ./$DRIVER ] && [ -f ./$CFG ]; then
            exec ./$DRIVER ./$CFG
        else
            echo "Driver or config not found. Checked paths:"
            echo "  $MUDHOME/bin/$DRIVER"
            echo "  $MUDHOME/../../build/driver"
            echo "  $MUDHOME/../build/driver"
            echo "  ./$DRIVER"
            echo "Config path: $CFG_PATH"
            break
        fi
        else
        if [ -f ./$DRIVER ]  && [ -f ./$CFG ] 
            then
            exec ./$DRIVER ./$CFG
            else
            break
        fi
    fi

done
